#cloud-config
# OpenClaw VPS Cloud-Init for Hetzner Ubuntu (4GB RAM, lightweight)
# Tailscale-only access, Brave browser with noVNC, dev tooling
#
# Usage:
# 1. Replace YOUR_TAILSCALE_AUTH_KEY with a reusable+ephemeral key from:
#    https://login.tailscale.com/admin/settings/keys
# 2. Replace YOUR_GITHUB_FORK with your fork URL (e.g., https://github.com/user/openclaw.git)
# 3. Paste into Hetzner "Cloud config" when creating the server
# 4. After boot, Hetzner firewall: block all inbound except UDP 41641

users:
  - name: timmy
    groups: users, admin, sudo
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: $6$54BaQ8LTuI0gmJxX$vgWuppD/9PqUTBpAzWtxtfdEl1Y2aakLtRy1i5jZQXOCWiaOA40peysu5DQqORh0PDyd/31pYA4ZipVmBMFmQ.
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOydEgQ3cNI4R1u69C6Nj4pu/UFjXj4+zkKg0OGm5B/U azure@arch
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINNneGS3Ip7s47xfp7Absn063qPr7e+TSaH6Etpui7bc azure@arch-personal

packages:
  - build-essential
  - curl
  - git
  - ca-certificates
  - gnupg
  - unzip
  - libxml2
  - socat
  - xvfb
  - x11vnc
  - novnc
  - websockify
  - fonts-liberation
  - fonts-noto-color-emoji
  - python3
  - ufw
  - trash-cli
  - jq

package_update: true
package_upgrade: true

write_files:
  # SSH hardening (still listens on all interfaces, but key-only + no root)
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      MaxAuthTries 3
      AllowUsers timmy

  # Systemd service for Xvfb (virtual display)
  - path: /etc/systemd/system/openclaw-xvfb.service
    content: |
      [Unit]
      Description=Xvfb Virtual Display
      After=network.target

      [Service]
      User=timmy
      ExecStart=/usr/bin/Xvfb :1 -screen 0 1280x800x24 -ac -nolisten tcp
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Systemd service for browser
  - path: /etc/systemd/system/openclaw-browser.service
    content: |
      [Unit]
      Description=OpenClaw Browser (Brave)
      After=openclaw-xvfb.service
      Requires=openclaw-xvfb.service

      [Service]
      User=timmy
      Environment=DISPLAY=:1
      Environment=HOME=/home/timmy
      ExecStartPre=/bin/sleep 2
      ExecStart=/usr/bin/brave-browser --remote-debugging-port=18800 --user-data-dir=/home/timmy/.openclaw/browser/clawd/user-data --no-sandbox --no-first-run --disable-dev-shm-usage about:blank
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Systemd service for x11vnc
  - path: /etc/systemd/system/openclaw-vnc.service
    content: |
      [Unit]
      Description=OpenClaw VNC Server
      After=openclaw-browser.service
      Requires=openclaw-browser.service

      [Service]
      User=timmy
      Environment=DISPLAY=:1
      ExecStart=/usr/bin/x11vnc -display :1 -rfbport 5900 -shared -forever -nopw -localhost
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Systemd service for noVNC websockify
  - path: /etc/systemd/system/openclaw-novnc.service
    content: |
      [Unit]
      Description=OpenClaw noVNC (websockify)
      After=openclaw-vnc.service
      Requires=openclaw-vnc.service

      [Service]
      User=timmy
      ExecStart=/usr/bin/websockify --web /usr/share/novnc/ 6080 localhost:5900
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

  # Systemd timer for trash auto-purge (30 days)
  - path: /etc/systemd/system/trash-empty.service
    content: |
      [Unit]
      Description=Empty trash older than 30 days

      [Service]
      Type=oneshot
      User=timmy
      ExecStart=/usr/bin/trash-empty 30

  - path: /etc/systemd/system/trash-empty.timer
    content: |
      [Unit]
      Description=Daily trash cleanup

      [Timer]
      OnCalendar=daily
      Persistent=true

      [Install]
      WantedBy=timers.target

  # Bashrc additions for timmy
  - path: /home/timmy/.bashrc.d/openclaw.sh
    content: |
      # OpenClaw environment
      export PATH="$HOME/.npm-global/bin:$HOME/openclaw/node_modules/.bin:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:$PATH"
      export NPM_CONFIG_PREFIX="$HOME/.npm-global"
      export HOMEBREW_NO_AUTO_UPDATE=1
      export HOMEBREW_NO_INSTALL_CLEANUP=1
      
      # Trash aliases
      alias trash='trash-put'
      # alias rm='echo "Use trash instead"; false'
      
      # Convenience aliases
      alias ll='ls -alF'
      alias openclaw='node ~/openclaw/dist/index.js'

runcmd:
  # --- Brave Browser ---
  - curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
  - echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main" > /etc/apt/sources.list.d/brave-browser-release.list
  - apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get install -y brave-browser

  # --- Node.js 22 ---
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
  - echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
  - apt-get update
  - DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
  - corepack enable

  # --- Tailscale ---
  - curl -fsSL https://tailscale.com/install.sh | sh
  - apt-get update && apt-get install -y tailscale
  - tailscale up --ssh --authkey=YOUR_TAILSCALE_AUTH_KEY --hostname=timmys-crib

  # --- UFW (block SSH from internet, allow Tailscale) ---
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 41641/udp comment 'Tailscale'
  # SSH only accessible via Tailscale SSH or Hetzner console
  - ufw --force enable

  # --- CodexBar CLI ---
  - curl -fsSL https://github.com/steipete/CodexBar/releases/download/v0.18.0-beta.2/CodexBarCLI-v0.18.0-beta.2-linux-x86_64.tar.gz | tar -xzf - -C /usr/local/bin
  - chmod +x /usr/local/bin/codexbar

  # --- Setup timmy's environment ---
  - mkdir -p /home/timmy/.npm-global /home/timmy/.openclaw /home/timmy/.bashrc.d /home/timmy/.ssh
  - chown -R timmy:timmy /home/timmy

  # --- Source bashrc.d in bashrc ---
  - echo 'for f in ~/.bashrc.d/*.sh; do [ -r "$f" ] && . "$f"; done' >> /home/timmy/.bashrc

  # --- Homebrew (as timmy) ---
  - mkdir -p /home/linuxbrew/.linuxbrew
  - chown -R timmy:timmy /home/linuxbrew
  - sudo -u timmy NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # --- GitHub CLI (as timmy via brew) ---
  - sudo -u timmy /home/linuxbrew/.linuxbrew/bin/brew install gh

  # --- Clone and build openclaw from source (as timmy) ---
  # Replace YOUR_GITHUB_FORK with your fork URL
  - sudo -u timmy git clone https://github.com/AzureDominus/openclaw.git /home/timmy/openclaw
  - npm install -g pnpm
  - sudo -u timmy bash -c 'cd /home/timmy/openclaw && pnpm install && pnpm build'

  # --- Configure openclaw ---
  - mkdir -p /home/timmy/.openclaw/browser/clawd/user-data
  - chown -R timmy:timmy /home/timmy/.openclaw
  - |
    cat > /home/timmy/.openclaw/openclaw.json << 'EOF'
    {
      "gateway": {
        "bind": "loopback",
        "tls": { "enabled": false },
        "tailscale": { "mode": "serve" },
        "auth": { "mode": "token" }
      },
      "browser": {
        "executablePath": "/usr/bin/brave-browser",
        "headless": false,
        "noSandbox": true,
        "defaultProfile": "clawd"
      }
    }
    EOF
  - chown timmy:timmy /home/timmy/.openclaw/openclaw.json

  # --- OpenClaw gateway systemd service ---
  - |
    cat > /etc/systemd/system/openclaw-gateway.service << 'EOF'
    [Unit]
    Description=OpenClaw Gateway
    After=network-online.target tailscaled.service openclaw-xvfb.service
    Wants=network-online.target
    Requires=openclaw-xvfb.service

    [Service]
    User=timmy
    WorkingDirectory=/home/timmy/openclaw
    ExecStart=/usr/bin/node /home/timmy/openclaw/dist/index.js gateway --port 18789
    Restart=always
    RestartSec=5
    KillMode=process
    Environment=HOME=/home/timmy
    Environment=DISPLAY=:1
    Environment=NODE_ENV=production
    Environment="PATH=/home/timmy/.npm-global/bin:/home/timmy/openclaw/node_modules/.bin:/home/linuxbrew/.linuxbrew/bin:/usr/local/bin:/usr/bin:/bin"

    [Install]
    WantedBy=multi-user.target
    EOF

  # --- RustDesk (mobile-friendly remote desktop) ---
  - curl -fsSL -o /tmp/rustdesk.deb https://github.com/rustdesk/rustdesk/releases/download/1.4.5/rustdesk-1.4.5-x86_64.deb
  - DEBIAN_FRONTEND=noninteractive apt-get install -y /tmp/rustdesk.deb
  - rm /tmp/rustdesk.deb
  # RustDesk systemd drop-in for DISPLAY
  - mkdir -p /etc/systemd/system/rustdesk.service.d
  - |
    cat > /etc/systemd/system/rustdesk.service.d/display.conf << 'EOF'
    [Service]
    Environment=DISPLAY=:1
    EOF
  # RustDesk config: direct IP access, Tailscale-only whitelist
  - mkdir -p /root/.config/rustdesk
  - |
    cat > /root/.config/rustdesk/RustDesk2.toml << 'EOF'
    rendezvous_server = 'rs-ny.rustdesk.com:21116'
    [options]
    approve-mode = 'password'
    direct-server = 'Y'
    direct-access-port = '21118'
    whitelist = '100.0.0.0/8'
    EOF
  # RustDesk setup script (sets password and enables service)
  - |
    cat > /usr/local/bin/rustdesk-setup << 'SCRIPT'
    #!/bin/bash
    set -e
    if [ -z "$1" ]; then
      echo "Usage: rustdesk-setup <password>"
      echo "Sets RustDesk password and enables the service."
      exit 1
    fi
    echo "Setting RustDesk password..."
    rustdesk --password "$1"
    echo "Enabling and starting RustDesk service..."
    systemctl daemon-reload
    systemctl enable --now rustdesk.service
    sleep 2
    TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "unknown")
    echo ""
    echo "RustDesk is ready!"
    echo "  Connect to: $TAILSCALE_IP"
    echo "  Password: $1"
    echo "  (Phone must be on Tailscale)"
    SCRIPT
  - chmod +x /usr/local/bin/rustdesk-setup
  # Disable rustdesk by default (user must run rustdesk-setup)
  - systemctl disable rustdesk.service

  # --- Enable services ---
  - systemctl daemon-reload
  - systemctl enable --now openclaw-xvfb.service
  - systemctl enable --now openclaw-browser.service
  - systemctl enable --now openclaw-vnc.service
  - systemctl enable --now openclaw-novnc.service
  - systemctl enable --now openclaw-gateway.service
  - systemctl enable --now trash-empty.timer

  # --- Tailscale serve for noVNC and gateway (HTTPS on tailnet) ---
  - tailscale serve --bg --https=443 http://127.0.0.1:18789
  - tailscale serve --bg --https=6443 http://localhost:6080

  # --- Add index.html redirect for noVNC ---
  - echo '<meta http-equiv="refresh" content="0; url=vnc.html">' > /usr/share/novnc/index.html

  # --- Generate gateway token ---
  - sudo -u timmy bash -c 'cd /home/timmy/openclaw && node dist/index.js doctor --generate-gateway-token'

  # --- Force password change on first console login (after all setup) ---
  - chage -d 0 timmy

  # --- Done ---
  - echo "OpenClaw VPS setup complete!" > /home/timmy/setup-complete.txt
  - chown timmy:timmy /home/timmy/setup-complete.txt
